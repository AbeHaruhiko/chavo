/// <reference path='../../../.tmp/typings/tsd.d.ts' />
Parse.Cloud.define('hello', function (request, response) {
    response.success('Hello world!');
});
Parse.Cloud.define('toggleLike', function (request, response) {
    // 人のvoiceのlikceCountをincrementするのでuseMasterKey
    Parse.Cloud.useMasterKey();
    var voice = request.params.voice;
    // ↓のトグルはローカルで実施済み
    // voice.like = !voice.like;
    var ParseVoice = Parse.Object.extend('Voice');
    var parseVoice = new ParseVoice();
    parseVoice.id = voice.objectId;
    if (voice.like) {
        request.user.addUnique('likes', voice.objectId);
        parseVoice.increment('likeCount');
    }
    else {
        request.user.remove('likes', voice.objectId);
        parseVoice.increment('likeCount', -1);
    }
    request.user.save()
        .then(function (user) {
        console.log('user: ' + user);
        console.log('likes: ' + user.get('likes'));
        return parseVoice.save();
    }, function (error) {
        console.error('Error: ' + error.code + ' ' + error.message);
        response.error('Error: ' + error.code + ' ' + error.message);
    })
        .then(function (parseVoice) {
        console.log('likeCound: ' + parseVoice.get('likeCount'));
        response.success(parseVoice.get('likeCount'));
    }, function (error) {
        console.error('Error: ' + error.code + ' ' + error.message);
        response.error('Error: ' + error.code + ' ' + error.message);
    });
});
Parse.Cloud.define('saveTag', function (request, response) {
    var tags = request.params.tags;
    tags.forEach(function (tag) {
        console.log(tag);
        var ParseTag = Parse.Object.extend('Tag');
        var query = new Parse.Query(ParseTag);
        query.equalTo('tag', tag);
        query.count().then(function (count) {
            console.log('count: ' + count);
            if (count === 0) {
                var parseTag = new ParseTag();
                parseTag.set('tag', tag);
                return parseTag.save();
            }
        })
            .then(function (parseTag) {
            if (parseTag) {
                console.log('saved tag: ' + parseTag.get('tag'));
            }
        });
    });
});
Parse.Cloud.define('addFamily', function (request, response) {
    // 人のChildを共有するようにACLを編集したりRoleを作ったりするのでマスターキー使用。
    Parse.Cloud.useMasterKey();
    // toUserIdかfromUserIdの家族を表すRoleがあるか
    var toUser = new Parse.User();
    var fromUser = new Parse.User();
    // 申請先ユーザ（承認者）
    toUser.id = request.user.id;
    // 申請元ユーザ（申請者）
    fromUser.id = request.params.familyApplication.fromUserObjectId;
    // 申請者、承認者のFamilyデータを検索する。
    var toUserFamilyQuery = new Parse.Query('Family');
    toUserFamilyQuery.equalTo('member', request.user);
    var fromUserFamilyQuery = new Parse.Query('Family');
    fromUserFamilyQuery.equalTo('member', fromUser);
    // orでクエリを作る。
    var familyQuery = Parse.Query.or(toUserFamilyQuery, fromUserFamilyQuery);
    var family;
    var familyRole;
    var children;
    familyQuery.first()
        .then(function (family) {
        console.log('enter 1');
        console.log(family);
        if (!family) {
            console.log('既存familyなし');
            // 既存のFamilyがないので作る。
            var ParseFamily = Parse.Object.extend('Family');
            family = new ParseFamily();
            family.setACL(new Parse.ACL());
        }
        var relation = family.relation('member');
        relation.add(toUser);
        relation.add(fromUser);
        return family.save();
    }).then(function (result) {
        console.log('enter 2');
        console.log(result);
        family = result;
        // .FamilyのオブジェクトIDをnameに持つRoleを探す。
        var familyRoleQuery = new Parse.Query(Parse.Role);
        console.log(result.id);
        familyRoleQuery.equalTo('name', result.id);
        return familyRoleQuery.first();
    }).then(function (result) {
        console.log('enter 3');
        console.log(result);
        if (result) {
            console.log('ロールあり: name = ' + family.id + ': ' + result);
            familyRole = result;
        }
        else {
            // 既存Roleがなければ作る。
            familyRole = new Parse.Role(family.id, new Parse.ACL());
            console.log('ロールなし: name = ' + family.id + 'を作ります。');
        }
        console.log(familyRole.getUsers());
        familyRole.getUsers().add(toUser);
        familyRole.getUsers().add(fromUser);
        return familyRole.save();
    }).then(function (result) {
        console.log('enter 4');
        console.log(result);
        // 承認者と申請者のこども情報を取得
        var ParseChild = Parse.Object.extend('Child');
        var toUserQuery = new Parse.Query(ParseChild);
        var fromUserQuery = new Parse.Query(ParseChild);
        // containedInはParse.Objectには使えない模様
        // query.containedIn('createdBy', [ toUser, fromUser ]);
        console.log('toUser:' + toUser);
        console.log('fromUser:' + fromUser);
        toUserQuery.equalTo('createdBy', toUser);
        fromUserQuery.equalTo('createdBy', fromUser);
        console.log(1);
        return Parse.Query.or(toUserQuery, fromUserQuery).find();
    }).then(function (parseChildren) {
        console.log('parseChildren:' + parseChildren);
        var promises = [];
        parseChildren.forEach(function (parseChild) {
            console.log('parseChild:' + parseChild);
            var childACL = new Parse.ACL();
            childACL.setRoleReadAccess(familyRole, true);
            childACL.setRoleWriteAccess(familyRole, true);
            parseChild.setACL(childACL);
        });
        promises.push(Parse.Object.saveAll(parseChildren));
        return Parse.Promise.when(promises);
    }).then(function () {
        console.log('enter 5');
        // 全投稿を取得
        var ParseVoice = Parse.Object.extend('Voice');
        // TODO: 'user'でなく'createdBy'にしたい。
        // containedInはParse.Objectには使えない模様
        // query.containedIn('user', [ toUser, fromUser ]);
        var toUserQuery = new Parse.Query(ParseVoice);
        var fromUserQuery = new Parse.Query(ParseVoice);
        toUserQuery.equalTo('user', toUser);
        fromUserQuery.equalTo('user', fromUser);
        var voiceQuery = Parse.Query.or(toUserQuery, fromUserQuery);
        return voiceQuery.count();
    }).then(function (countResult) {
        console.log('countResult:' + countResult);
        var promises = [];
        var ParseVoice = Parse.Object.extend('Voice');
        var toUserQuery = new Parse.Query(ParseVoice);
        var fromUserQuery = new Parse.Query(ParseVoice);
        toUserQuery.equalTo('user', toUser);
        fromUserQuery.equalTo('user', fromUser);
        var voiceQuery = Parse.Query.or(toUserQuery, fromUserQuery);
        for (var i = 0; i < countResult / 1000; i++) {
            voiceQuery.limit(1000);
            voiceQuery.skip(1000 * i);
            promises.push(voiceQuery.find());
        }
        return Parse.Promise.when(promises);
    }).then(function () {
        var voicesArray = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            voicesArray[_i - 0] = arguments[_i];
        }
        console.log('voices:' + voicesArray);
        var promises = [];
        voicesArray.forEach(function (voices) {
            voices.forEach(function (voice) {
                console.log('voice:' + voice);
                var voiceACL = new Parse.ACL();
                voiceACL.setRoleReadAccess(familyRole, true);
                voiceACL.setRoleWriteAccess(familyRole, true);
                voice.setACL(voiceACL);
            });
            promises.push(Parse.Object.saveAll(voices));
            return Parse.Promise.when(promises);
        });
    }).then(function () {
        console.log('enter 6');
        response.success('Success!');
    }, function (error) {
        console.error('Error: ' + error.code + ' ' + error.message);
        response.error('Error! see log on Parse.com.');
    });
});
Parse.Cloud.define('getRequestUsersFamilyRole', function (request, response) {
    Parse.Cloud.useMasterKey();
    var familyQuery = new Parse.Query('Family');
    familyQuery.equalTo('member', request.user);
    familyQuery.first()
        .then(function (result) {
        if (result) {
            var roleQuery = new Parse.Query(Parse.Role);
            roleQuery.equalTo('name', result.id);
            return roleQuery.first();
        }
        else {
            return Parse.Promise.as(null);
        }
    }).then(function (result) {
        response.success(result);
    });
});
Parse.Cloud.define('getRequestUsersFamilyMember', function (request, response) {
    Parse.Cloud.useMasterKey();
    var familyQuery = new Parse.Query('Family');
    familyQuery.equalTo('member', request.user);
    familyQuery.first()
        .then(function (result) {
        console.log(result);
        var query = result.relation('member').query();
        // 他ユーザに返却するのでパスワードなどは返さない。
        query.select('username', 'iconUrl');
        return query.find();
    }).then(function (result) {
        console.log(result);
        response.success(result);
    });
});
Parse.Cloud.define('getFamilyAppToRequestUser', function (request, response) {
    Parse.Cloud.useMasterKey();
    var ParseFamilyApplication = Parse.Object.extend('FamilyApplication');
    var query = new Parse.Query(ParseFamilyApplication);
    query.descending('createdAt');
    // 自分宛て
    query.equalTo('toUser', request.user);
    query.include('fromUser');
    query.find()
        .then(function (result) {
        response.success(result);
    }, function (error) {
        response.error(error);
    });
});
Parse.Cloud.define('getFamilyAppFromRequestUser', function (request, response) {
    Parse.Cloud.useMasterKey();
    var ParseFamilyApplication = Parse.Object.extend('FamilyApplication');
    var query = new Parse.Query(ParseFamilyApplication);
    query.descending('createdAt');
    // 自分宛て
    query.equalTo('fromUser', request.user);
    query.include('fromUser');
    query.include('toUser');
    query.find()
        .then(function (result) {
        response.success(result);
    }, function (error) {
        response.error(error);
    });
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsb3VkL21haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsdURBQXVEO0FBRXZELEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxVQUFTLE9BQW9DLEVBQUUsUUFBc0M7SUFDL0csUUFBUSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUNuQyxDQUFDLENBQUMsQ0FBQztBQUVILEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxVQUFTLE9BQW9DLEVBQUUsUUFBc0M7SUFFcEgsK0NBQStDO0lBQy9DLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDM0IsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDakMsa0JBQWtCO0lBQ2xCLDRCQUE0QjtJQUU1QixJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QyxJQUFJLFVBQVUsR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO0lBQ2xDLFVBQVUsQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQztJQUUvQixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNmLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDaEQsVUFBVSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdDLFVBQVUsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO1NBQ2xCLElBQUksQ0FBQyxVQUFDLElBQWdCO1FBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUMzQyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzNCLENBQUMsRUFDRCxVQUFDLEtBQWtCO1FBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU1RCxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDL0QsQ0FBQyxDQUFDO1NBQ0QsSUFBSSxDQUFDLFVBQUMsVUFBd0I7UUFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBQ3pELFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO0lBQ2hELENBQUMsRUFDRCxVQUFDLEtBQWtCO1FBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU1RCxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDL0QsQ0FBQyxDQUFDLENBQUM7QUFFTCxDQUFDLENBQUMsQ0FBQztBQUVILEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMs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WSxFQUFFLENBQUM7SUFFM0IsSUFBSSxzQkFBc0IsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3RFLElBQUksS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ3BELEtBQUssQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDOUIsT0FBTztJQUNQLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4QyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzFCLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDeEIsS0FBSyxDQUFDLElBQUksRUFBRTtTQUNYLElBQUksQ0FBQyxVQUFDLE1BQXNCO1FBQzNCLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDM0IsQ0FBQyxFQUNELFVBQUMsS0FBa0I7UUFDakIsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6ImNsb3VkL21haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPScuLi8uLi8uLi8udG1wL3R5cGluZ3MvdHNkLmQudHMnIC8+XG5cblBhcnNlLkNsb3VkLmRlZmluZSgnaGVsbG8nLCBmdW5jdGlvbihyZXF1ZXN0OiBQYXJzZS5DbG91ZC5GdW5jdGlvblJlcXVlc3QsIHJlc3BvbnNlOiBQYXJzZS5DbG91ZC5GdW5jdGlvblJlc3BvbnNlKSB7XG4gIHJlc3BvbnNlLnN1Y2Nlc3MoJ0hlbGxvIHdvcmxkIScpO1xufSk7XG5cblBhcnNlLkNsb3VkLmRlZmluZSgndG9nZ2xlTGlrZScsIGZ1bmN0aW9uKHJlcXVlc3Q6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVxdWVzdCwgcmVzcG9uc2U6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVzcG9uc2UpIHtcblxuICAvLyDkurrjga52b2ljZeOBrmxpa2NlQ291bnTjgpJpbmNyZW1lbnTjgZnjgovjga7jgad1c2VNYXN0ZXJLZXlcbiAgUGFyc2UuQ2xvdWQudXNlTWFzdGVyS2V5KCk7XG4gIHZhciB2b2ljZSA9IHJlcXVlc3QucGFyYW1zLnZvaWNlO1xuICAvLyDihpPjga7jg4jjgrDjg6vjga/jg63jg7zjgqvjg6vjgaflrp/mlr3muIjjgb9cbiAgLy8gdm9pY2UubGlrZSA9ICF2b2ljZS5saWtlO1xuXG4gIHZhciBQYXJzZVZvaWNlID0gUGFyc2UuT2JqZWN0LmV4dGVuZCgnVm9pY2UnKTtcbiAgdmFyIHBhcnNlVm9pY2UgPSBuZXcgUGFyc2VWb2ljZSgpO1xuICBwYXJzZVZvaWNlLmlkID0gdm9pY2Uub2JqZWN0SWQ7XG5cbiAgaWYgKHZvaWNlLmxpa2UpIHtcbiAgICByZXF1ZXN0LnVzZXIuYWRkVW5pcXVlKCdsaWtlcycsIHZvaWNlLm9iamVjdElkKTtcbiAgICBwYXJzZVZvaWNlLmluY3JlbWVudCgnbGlrZUNvdW50Jyk7XG4gIH0gZWxzZSB7XG4gICAgcmVxdWVzdC51c2VyLnJlbW92ZSgnbGlrZXMnLCB2b2ljZS5vYmplY3RJZCk7XG4gICAgcGFyc2VWb2ljZS5pbmNyZW1lbnQoJ2xpa2VDb3VudCcsIC0xKTtcbiAgfVxuXG4gIHJlcXVlc3QudXNlci5zYXZlKClcbiAgLnRoZW4oKHVzZXI6IFBhcnNlLlVzZXIpID0+IHtcbiAgICBjb25zb2xlLmxvZygndXNlcjogJyArIHVzZXIpO1xuICAgIGNvbnNvbGUubG9nKCdsaWtlczogJyArIHVzZXIuZ2V0KCdsaWtlcycpKTtcbiAgICByZXR1cm4gcGFyc2VWb2ljZS5zYXZlKCk7XG4gIH0sXG4gIChlcnJvcjogUGFyc2UuRXJyb3IpID0+IHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjogJyArIGVycm9yLmNvZGUgKyAnICcgKyBlcnJvci5tZXNzYWdlKTtcblxuICAgIHJlc3BvbnNlLmVycm9yKCdFcnJvcjogJyArIGVycm9yLmNvZGUgKyAnICcgKyBlcnJvci5tZXNzYWdlKTtcbiAgfSlcbiAgLnRoZW4oKHBhcnNlVm9pY2U6IFBhcnNlLk9iamVjdCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdsaWtlQ291bmQ6ICcgKyBwYXJzZVZvaWNlLmdldCgnbGlrZUNvdW50JykpO1xuICAgIHJlc3BvbnNlLnN1Y2Nlc3MocGFyc2VWb2ljZS5nZXQoJ2xpa2VDb3VudCcpKTtcbiAgfSxcbiAgKGVycm9yOiBQYXJzZS5FcnJvcikgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOiAnICsgZXJyb3IuY29kZSArICcgJyArIGVycm9yLm1lc3NhZ2UpO1xuXG4gICAgcmVzcG9uc2UuZXJyb3IoJ0Vycm9yOiAnICsgZXJyb3IuY29kZSArICcgJyArIGVycm9yLm1lc3NhZ2UpO1xuICB9KTtcblxufSk7XG5cblBhcnNlLkNsb3VkLmRlZmluZSgnc2F2ZVRhZycsIGZ1bmN0aW9uKHJlcXVlc3Q6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVxdWVzdCwgcmVzcG9uc2U6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVzcG9uc2UpIHtcbiAgdmFyIHRhZ3M6IHN0cmluZ1tdID0gcmVxdWVzdC5wYXJhbXMudGFncztcblxuICB0YWdzLmZvckVhY2goKHRhZzogc3RyaW5nKSA9PiB7XG4gICAgY29uc29sZS5sb2codGFnKTtcbiAgICB2YXIgUGFyc2VUYWcgPSBQYXJzZS5PYmplY3QuZXh0ZW5kKCdUYWcnKTtcblxuICAgIHZhciBxdWVyeSA9IG5ldyBQYXJzZS5RdWVyeShQYXJzZVRhZyk7XG4gICAgcXVlcnkuZXF1YWxUbygndGFnJywgdGFnKTtcbiAgICBxdWVyeS5jb3VudCgpLnRoZW4oKGNvdW50OiBudW1iZXIpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdjb3VudDogJyArIGNvdW50KTtcbiAgICAgIGlmIChjb3VudCA9PT0gMCkge1xuICAgICAgICB2YXIgcGFyc2VUYWcgPSBuZXcgUGFyc2VUYWcoKTtcbiAgICAgICAgcGFyc2VUYWcuc2V0KCd0YWcnLCB0YWcpO1xuICAgICAgICByZXR1cm4gcGFyc2VUYWcuc2F2ZSgpO1xuICAgICAgfVxuICAgIH0pXG4gICAgLnRoZW4oKHBhcnNlVGFnOiBQYXJzZS5PYmplY3QpID0+IHtcbiAgICAgIGlmIChwYXJzZVRhZykge1xuICAgICAgICBjb25zb2xlLmxvZygnc2F2ZWQgdGFnOiAnICsgcGFyc2VUYWcuZ2V0KCd0YWcnKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG59KTtcblxuUGFyc2UuQ2xvdWQuZGVmaW5lKCdhZGRGYW1pbHknLCBmdW5jdGlvbihyZXF1ZXN0OiBQYXJzZS5DbG91ZC5GdW5jdGlvblJlcXVlc3QsIHJlc3BvbnNlOiBQYXJzZS5DbG91ZC5GdW5jdGlvblJlc3BvbnNlKSB7XG5cbiAgLy8g5Lq644GuQ2hpbGTjgpLlhbHmnInjgZnjgovjgojjgYbjgatBQ0zjgpLnt6jpm4bjgZfjgZ/jgopSb2xl44KS5L2c44Gj44Gf44KK44GZ44KL44Gu44Gn44Oe44K544K/44O844Kt44O85L2/55So44CCXG4gIFBhcnNlLkNsb3VkLnVzZU1hc3RlcktleSgpO1xuXG4gIC8vIHRvVXNlcklk44GLZnJvbVVzZXJJZOOBruWutuaXj+OCkuihqOOBmVJvbGXjgYzjgYLjgovjgYtcbiAgdmFyIHRvVXNlciA9IG5ldyBQYXJzZS5Vc2VyKCk7XG4gIHZhciBmcm9tVXNlciA9IG5ldyBQYXJzZS5Vc2VyKCk7XG5cbiAgLy8g55Sz6KuL5YWI44Om44O844K277yI5om/6KqN6ICF77yJXG4gIHRvVXNlci5pZCA9IHJlcXVlc3QudXNlci5pZDtcbiAgLy8g55Sz6KuL5YWD44Om44O844K277yI55Sz6KuL6ICF77yJXG4gIGZyb21Vc2VyLmlkID0gcmVxdWVzdC5wYXJhbXMuZmFtaWx5QXBwbGljYXRpb24uZnJvbVVzZXJPYmplY3RJZDtcblxuICAvLyDnlLPoq4vogIXjgIHmib/oqo3ogIXjga5GYW1pbHnjg4fjg7zjgr/jgpLmpJzntKLjgZnjgovjgIJcbiAgdmFyIHRvVXNlckZhbWlseVF1ZXJ5ID0gbmV3IFBhcnNlLlF1ZXJ5KCdGYW1pbHknKTtcbiAgdG9Vc2VyRmFtaWx5UXVlcnkuZXF1YWxUbygnbWVtYmVyJywgcmVxdWVzdC51c2VyKTtcblxuICB2YXIgZnJvbVVzZXJGYW1pbHlRdWVyeSA9IG5ldyBQYXJzZS5RdWVyeSgnRmFtaWx5Jyk7XG4gIGZyb21Vc2VyRmFtaWx5UXVlcnkuZXF1YWxUbygnbWVtYmVyJywgZnJvbVVzZXIpO1xuXG4gLy8gb3Ljgafjgq/jgqjjg6rjgpLkvZzjgovjgIJcbiAgdmFyIGZhbWlseVF1ZXJ5ID0gUGFyc2UuUXVlcnkub3IodG9Vc2VyRmFtaWx5UXVlcnksIGZyb21Vc2VyRmFtaWx5UXVlcnkpO1xuICB2YXIgZmFtaWx5OiBQYXJzZS5PYmplY3Q7XG4gIHZhciBmYW1pbHlSb2xlOiBQYXJzZS5Sb2xlO1xuICB2YXIgY2hpbGRyZW46IFBhcnNlLk9iamVjdFtdO1xuICBmYW1pbHlRdWVyeS5maXJzdCgpXG4gIC50aGVuKChmYW1pbHk6IFBhcnNlLk9iamVjdCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdlbnRlciAxJyk7XG4gICAgY29uc29sZS5sb2coZmFtaWx5KTtcblxuICAgIGlmICghZmFtaWx5KSB7XG4gICAgICBjb25zb2xlLmxvZygn5pei5a2YZmFtaWx544Gq44GXJyk7XG4gICAgICAvLyDml6LlrZjjga5GYW1pbHnjgYzjgarjgYTjga7jgafkvZzjgovjgIJcbiAgICAgIHZhciBQYXJzZUZhbWlseSA9IFBhcnNlLk9iamVjdC5leHRlbmQoJ0ZhbWlseScpO1xuICAgICAgZmFtaWx5ID0gbmV3IFBhcnNlRmFtaWx5KCk7XG4gICAgICBmYW1pbHkuc2V0QUNMKG5ldyBQYXJzZS5BQ0woKSk7XG4gICAgfVxuICAgIHZhciByZWxhdGlvbiA9IGZhbWlseS5yZWxhdGlvbignbWVtYmVyJyk7XG4gICAgcmVsYXRpb24uYWRkKHRvVXNlcik7XG4gICAgcmVsYXRpb24uYWRkKGZyb21Vc2VyKTtcbiAgICByZXR1cm4gZmFtaWx5LnNhdmUoKTtcblxuICB9KS50aGVuKChyZXN1bHQ6IFBhcnNlLk9iamVjdCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdlbnRlciAyJyk7XG4gICAgY29uc29sZS5sb2cocmVzdWx0KTtcblxuICAgIGZhbWlseSA9IHJlc3VsdDtcblxuICAgIC8vIC5GYW1pbHnjga7jgqrjg5bjgrjjgqfjgq/jg4hJROOCkm5hbWXjgavmjIHjgaRSb2xl44KS5o6i44GZ44CCXG4gICAgdmFyIGZhbWlseVJvbGVRdWVyeSA9IG5ldyBQYXJzZS5RdWVyeShQYXJzZS5Sb2xlKTtcbiAgICBjb25zb2xlLmxvZyhyZXN1bHQuaWQpO1xuICAgIGZhbWlseVJvbGVRdWVyeS5lcXVhbFRvKCduYW1lJywgcmVzdWx0LmlkKTtcbiAgICByZXR1cm4gZmFtaWx5Um9sZVF1ZXJ5LmZpcnN0KCk7XG5cbiAgfSkudGhlbigocmVzdWx0OiBQYXJzZS5Sb2xlKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ2VudGVyIDMnKTtcbiAgICBjb25zb2xlLmxvZyhyZXN1bHQpO1xuXG4gICAgaWYgKHJlc3VsdCkge1xuICAgICAgY29uc29sZS5sb2coJ+ODreODvOODq+OBguOCijogbmFtZSA9ICcgKyBmYW1pbHkuaWQgKyAnOiAnICsgcmVzdWx0KTtcbiAgICAgIGZhbWlseVJvbGUgPSByZXN1bHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOaXouWtmFJvbGXjgYzjgarjgZHjgozjgbDkvZzjgovjgIJcbiAgICAgIGZhbWlseVJvbGUgPSBuZXcgUGFyc2UuUm9sZShmYW1pbHkuaWQsIG5ldyBQYXJzZS5BQ0woKSk7XG4gICAgICBjb25zb2xlLmxvZygn44Ot44O844Or44Gq44GXOiBuYW1lID0gJyArIGZhbWlseS5pZCArICfjgpLkvZzjgorjgb7jgZnjgIInKTtcbiAgICB9XG4gICAgY29uc29sZS5sb2coZmFtaWx5Um9sZS5nZXRVc2VycygpKTtcbiAgICBmYW1pbHlSb2xlLmdldFVzZXJzKCkuYWRkKHRvVXNlcik7XG4gICAgZmFtaWx5Um9sZS5nZXRVc2VycygpLmFkZChmcm9tVXNlcik7XG4gICAgcmV0dXJuIGZhbWlseVJvbGUuc2F2ZSgpO1xuXG4gIH0pLnRoZW4oKHJlc3VsdDogUGFyc2UuUm9sZSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdlbnRlciA0Jyk7XG4gICAgY29uc29sZS5sb2cocmVzdWx0KTtcblxuICAgIC8vIOaJv+iqjeiAheOBqOeUs+iri+iAheOBruOBk+OBqeOCguaDheWgseOCkuWPluW+l1xuICAgIGxldCBQYXJzZUNoaWxkID0gUGFyc2UuT2JqZWN0LmV4dGVuZCgnQ2hpbGQnKTtcbiAgICBsZXQgdG9Vc2VyUXVlcnkgPSBuZXcgUGFyc2UuUXVlcnkoUGFyc2VDaGlsZCk7XG4gICAgbGV0IGZyb21Vc2VyUXVlcnkgPSBuZXcgUGFyc2UuUXVlcnkoUGFyc2VDaGlsZCk7XG5cbiAgICAvLyBjb250YWluZWRJbuOBr1BhcnNlLk9iamVjdOOBq+OBr+S9v+OBiOOBquOBhOaooeanmFxuICAgIC8vIHF1ZXJ5LmNvbnRhaW5lZEluKCdjcmVhdGVkQnknLCBbIHRvVXNlciwgZnJvbVVzZXIgXSk7XG4gICAgY29uc29sZS5sb2coJ3RvVXNlcjonICsgdG9Vc2VyKTtcbiAgICBjb25zb2xlLmxvZygnZnJvbVVzZXI6JyArIGZyb21Vc2VyKTtcblxuICAgIHRvVXNlclF1ZXJ5LmVxdWFsVG8oJ2NyZWF0ZWRCeScsIHRvVXNlcik7XG4gICAgZnJvbVVzZXJRdWVyeS5lcXVhbFRvKCdjcmVhdGVkQnknLCBmcm9tVXNlcik7XG4gICAgY29uc29sZS5sb2coMSk7XG5cbiAgICByZXR1cm4gUGFyc2UuUXVlcnkub3IodG9Vc2VyUXVlcnksIGZyb21Vc2VyUXVlcnkpLmZpbmQoKTtcbiAgfSkudGhlbigocGFyc2VDaGlsZHJlbjogUGFyc2UuT2JqZWN0W10pID0+IHtcbiAgICBjb25zb2xlLmxvZygncGFyc2VDaGlsZHJlbjonICsgcGFyc2VDaGlsZHJlbik7XG5cbiAgICB2YXIgcHJvbWlzZXMgPSBbXTtcblxuICAgIHBhcnNlQ2hpbGRyZW4uZm9yRWFjaCgocGFyc2VDaGlsZDogUGFyc2UuT2JqZWN0KSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygncGFyc2VDaGlsZDonICsgcGFyc2VDaGlsZCk7XG4gICAgICB2YXIgY2hpbGRBQ0wgPSBuZXcgUGFyc2UuQUNMKCk7XG4gICAgICBjaGlsZEFDTC5zZXRSb2xlUmVhZEFjY2VzcyhmYW1pbHlSb2xlLCB0cnVlKTtcbiAgICAgIGNoaWxkQUNMLnNldFJvbGVXcml0ZUFjY2VzcyhmYW1pbHlSb2xlLCB0cnVlKTtcbiAgICAgIHBhcnNlQ2hpbGQuc2V0QUNMKGNoaWxkQUNMKTtcbiAgICB9KTtcbiAgICBwcm9taXNlcy5wdXNoKFBhcnNlLk9iamVjdC5zYXZlQWxsKHBhcnNlQ2hpbGRyZW4pKTtcbiAgICByZXR1cm4gUGFyc2UuUHJvbWlzZS53aGVuKHByb21pc2VzKTtcblxuICB9KS50aGVuKCgpID0+IHtcbiAgICBjb25zb2xlLmxvZygnZW50ZXIgNScpO1xuXG4gICAgLy8g5YWo5oqV56i/44KS5Y+W5b6XXG4gICAgbGV0IFBhcnNlVm9pY2UgPSBQYXJzZS5PYmplY3QuZXh0ZW5kKCdWb2ljZScpO1xuICAgIC8vIFRPRE86ICd1c2VyJ+OBp+OBquOBjydjcmVhdGVkQnkn44Gr44GX44Gf44GE44CCXG5cbiAgICAvLyBjb250YWluZWRJbuOBr1BhcnNlLk9iamVjdOOBq+OBr+S9v+OBiOOBquOBhOaooeanmFxuICAgIC8vIHF1ZXJ5LmNvbnRhaW5lZEluKCd1c2VyJywgWyB0b1VzZXIsIGZyb21Vc2VyIF0pO1xuXG4gICAgbGV0IHRvVXNlclF1ZXJ5ID0gbmV3IFBhcnNlLlF1ZXJ5KFBhcnNlVm9pY2UpO1xuICAgIGxldCBmcm9tVXNlclF1ZXJ5ID0gbmV3IFBhcnNlLlF1ZXJ5KFBhcnNlVm9pY2UpO1xuXG4gICAgdG9Vc2VyUXVlcnkuZXF1YWxUbygndXNlcicsIHRvVXNlcik7XG4gICAgZnJvbVVzZXJRdWVyeS5lcXVhbFRvKCd1c2VyJywgZnJvbVVzZXIpO1xuICAgIHZhciB2b2ljZVF1ZXJ5ID0gUGFyc2UuUXVlcnkub3IodG9Vc2VyUXVlcnksIGZyb21Vc2VyUXVlcnkpO1xuXG4gICAgcmV0dXJuIHZvaWNlUXVlcnkuY291bnQoKTtcblxuICB9KS50aGVuKChjb3VudFJlc3VsdDogbnVtYmVyKSA9PiB7XG5cbiAgICBjb25zb2xlLmxvZygnY291bnRSZXN1bHQ6JyArIGNvdW50UmVzdWx0KTtcblxuICAgIHZhciBwcm9taXNlcyA9IFtdO1xuXG4gICAgbGV0IFBhcnNlVm9pY2UgPSBQYXJzZS5PYmplY3QuZXh0ZW5kKCdWb2ljZScpO1xuICAgIGxldCB0b1VzZXJRdWVyeSA9IG5ldyBQYXJzZS5RdWVyeShQYXJzZVZvaWNlKTtcbiAgICBsZXQgZnJvbVVzZXJRdWVyeSA9IG5ldyBQYXJzZS5RdWVyeShQYXJzZVZvaWNlKTtcblxuICAgIHRvVXNlclF1ZXJ5LmVxdWFsVG8oJ3VzZXInLCB0b1VzZXIpO1xuICAgIGZyb21Vc2VyUXVlcnkuZXF1YWxUbygndXNlcicsIGZyb21Vc2VyKTtcbiAgICB2YXIgdm9pY2VRdWVyeSA9IFBhcnNlLlF1ZXJ5Lm9yKHRvVXNlclF1ZXJ5LCBmcm9tVXNlclF1ZXJ5KTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnRSZXN1bHQgLyAxMDAwOyBpKyspIHtcbiAgICAgIHZvaWNlUXVlcnkubGltaXQoMTAwMCk7XG4gICAgICB2b2ljZVF1ZXJ5LnNraXAoMTAwMCAqIGkpO1xuICAgICAgcHJvbWlzZXMucHVzaCh2b2ljZVF1ZXJ5LmZpbmQoKSk7XG4gICAgfVxuICAgIHJldHVybiBQYXJzZS5Qcm9taXNlLndoZW4ocHJvbWlzZXMpO1xuXG4gIH0pLnRoZW4oKC4uLnZvaWNlc0FycmF5OiBQYXJzZS5PYmplY3RbXVtdKSA9PiB7XG5cbiAgICBjb25zb2xlLmxvZygndm9pY2VzOicgKyB2b2ljZXNBcnJheSk7XG5cbiAgICB2YXIgcHJvbWlzZXMgPSBbXTtcblxuICAgIHZvaWNlc0FycmF5LmZvckVhY2goKHZvaWNlczogUGFyc2UuT2JqZWN0W10pID0+IHtcblxuICAgICAgdm9pY2VzLmZvckVhY2goKHZvaWNlOiBQYXJzZS5PYmplY3QpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ3ZvaWNlOicgKyB2b2ljZSk7XG4gICAgICAgIHZhciB2b2ljZUFDTCA9IG5ldyBQYXJzZS5BQ0woKTtcbiAgICAgICAgdm9pY2VBQ0wuc2V0Um9sZVJlYWRBY2Nlc3MoZmFtaWx5Um9sZSwgdHJ1ZSk7XG4gICAgICAgIHZvaWNlQUNMLnNldFJvbGVXcml0ZUFjY2VzcyhmYW1pbHlSb2xlLCB0cnVlKTtcbiAgICAgICAgdm9pY2Uuc2V0QUNMKHZvaWNlQUNMKTtcbiAgICAgIH0pO1xuICAgICAgcHJvbWlzZXMucHVzaChQYXJzZS5PYmplY3Quc2F2ZUFsbCh2b2ljZXMpKTtcbiAgICAgIHJldHVybiBQYXJzZS5Qcm9taXNlLndoZW4ocHJvbWlzZXMpO1xuXG4gICAgfSk7XG5cbiAgfSkudGhlbigoKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ2VudGVyIDYnKTtcblxuICAgIHJlc3BvbnNlLnN1Y2Nlc3MoJ1N1Y2Nlc3MhJyk7XG4gIH0sXG4gIChlcnJvcjogUGFyc2UuRXJyb3IpID0+IHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjogJyArIGVycm9yLmNvZGUgKyAnICcgKyBlcnJvci5tZXNzYWdlKTtcbiAgICByZXNwb25zZS5lcnJvcignRXJyb3IhIHNlZSBsb2cgb24gUGFyc2UuY29tLicpO1xuICB9KTtcbn0pO1xuXG5QYXJzZS5DbG91ZC5kZWZpbmUoJ2dldFJlcXVlc3RVc2Vyc0ZhbWlseVJvbGUnLCBmdW5jdGlvbihyZXF1ZXN0OiBQYXJzZS5DbG91ZC5GdW5jdGlvblJlcXVlc3QsIHJlc3BvbnNlOiBQYXJzZS5DbG91ZC5GdW5jdGlvblJlc3BvbnNlKSB7XG5cbiAgUGFyc2UuQ2xvdWQudXNlTWFzdGVyS2V5KCk7XG5cbiAgdmFyIGZhbWlseVF1ZXJ5ID0gbmV3IFBhcnNlLlF1ZXJ5KCdGYW1pbHknKTtcbiAgZmFtaWx5UXVlcnkuZXF1YWxUbygnbWVtYmVyJywgcmVxdWVzdC51c2VyKTtcbiAgZmFtaWx5UXVlcnkuZmlyc3QoKVxuICAudGhlbigocmVzdWx0OiBQYXJzZS5PYmplY3QpID0+IHtcblxuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICB2YXIgcm9sZVF1ZXJ5ID0gbmV3IFBhcnNlLlF1ZXJ5KFBhcnNlLlJvbGUpO1xuICAgICAgICByb2xlUXVlcnkuZXF1YWxUbygnbmFtZScsIHJlc3VsdC5pZCk7XG4gICAgICAgIHJldHVybiByb2xlUXVlcnkuZmlyc3QoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBQYXJzZS5Qcm9taXNlLmFzKG51bGwpO1xuICAgICAgfVxuICB9KS50aGVuKChyZXN1bHQ6IFBhcnNlLlJvbGUpID0+IHtcbiAgICByZXNwb25zZS5zdWNjZXNzKHJlc3VsdCk7XG4gIH0pO1xufSk7XG5cblBhcnNlLkNsb3VkLmRlZmluZSgnZ2V0UmVxdWVzdFVzZXJzRmFtaWx5TWVtYmVyJywgZnVuY3Rpb24ocmVxdWVzdDogUGFyc2UuQ2xvdWQuRnVuY3Rpb25SZXF1ZXN0LCByZXNwb25zZTogUGFyc2UuQ2xvdWQuRnVuY3Rpb25SZXNwb25zZSkge1xuXG4gIFBhcnNlLkNsb3VkLnVzZU1hc3RlcktleSgpO1xuXG4gIHZhciBmYW1pbHlRdWVyeSA9IG5ldyBQYXJzZS5RdWVyeSgnRmFtaWx5Jyk7XG4gIGZhbWlseVF1ZXJ5LmVxdWFsVG8oJ21lbWJlcicsIHJlcXVlc3QudXNlcik7XG4gIGZhbWlseVF1ZXJ5LmZpcnN0KClcbiAgLnRoZW4oKHJlc3VsdDogUGFyc2UuT2JqZWN0KSA9PiB7XG4gICAgY29uc29sZS5sb2cocmVzdWx0KTtcbiAgICB2YXIgcXVlcnkgPSByZXN1bHQucmVsYXRpb24oJ21lbWJlcicpLnF1ZXJ5KCk7XG4gICAgLy8g5LuW44Om44O844K244Gr6L+U5Y2044GZ44KL44Gu44Gn44OR44K544Ov44O844OJ44Gq44Gp44Gv6L+U44GV44Gq44GE44CCXG4gICAgcXVlcnkuc2VsZWN0KCd1c2VybmFtZScsICdpY29uVXJsJyk7XG4gICAgcmV0dXJuIHF1ZXJ5LmZpbmQoKTtcbiAgfSkudGhlbigocmVzdWx0OiBQYXJzZS5PYmplY3RbXSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7XG4gICAgcmVzcG9uc2Uuc3VjY2VzcyhyZXN1bHQpO1xuICB9KTtcbn0pO1xuXG5QYXJzZS5DbG91ZC5kZWZpbmUoJ2dldEZhbWlseUFwcFRvUmVxdWVzdFVzZXInLCBmdW5jdGlvbihyZXF1ZXN0OiBQYXJzZS5DbG91ZC5GdW5jdGlvblJlcXVlc3QsIHJlc3BvbnNlOiBQYXJzZS5DbG91ZC5GdW5jdGlvblJlc3BvbnNlKSB7XG5cbiAgUGFyc2UuQ2xvdWQudXNlTWFzdGVyS2V5KCk7XG5cbiAgdmFyIFBhcnNlRmFtaWx5QXBwbGljYXRpb24gPSBQYXJzZS5PYmplY3QuZXh0ZW5kKCdGYW1pbHlBcHBsaWNhdGlvbicpO1xuICB2YXIgcXVlcnkgPSBuZXcgUGFyc2UuUXVlcnkoUGFyc2VGYW1pbHlBcHBsaWNhdGlvbik7XG4gIHF1ZXJ5LmRlc2NlbmRpbmcoJ2NyZWF0ZWRBdCcpO1xuICAvLyDoh6rliIblrpvjgaZcbiAgcXVlcnkuZXF1YWxUbygndG9Vc2VyJywgcmVxdWVzdC51c2VyKTtcbiAgcXVlcnkuaW5jbHVkZSgnZnJvbVVzZXInKTtcbiAgcXVlcnkuZmluZCgpXG4gIC50aGVuKChyZXN1bHQ6IFBhcnNlLk9iamVjdFtdKSA9PiB7XG4gICAgcmVzcG9uc2Uuc3VjY2VzcyhyZXN1bHQpO1xuICB9LFxuICAoZXJyb3I6IFBhcnNlLkVycm9yKSA9PiB7XG4gICAgcmVzcG9uc2UuZXJyb3IoZXJyb3IpO1xuICB9KTtcbn0pO1xuXG5QYXJzZS5DbG91ZC5kZWZpbmUoJ2dldEZhbWlseUFwcEZyb21SZXF1ZXN0VXNlcicsIGZ1bmN0aW9uKHJlcXVlc3Q6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVxdWVzdCwgcmVzcG9uc2U6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVzcG9uc2UpIHtcblxuICBQYXJzZS5DbG91ZC51c2VNYXN0ZXJLZXkoKTtcblxuICB2YXIgUGFyc2VGYW1pbHlBcHBsaWNhdGlvbiA9IFBhcnNlLk9iamVjdC5leHRlbmQoJ0ZhbWlseUFwcGxpY2F0aW9uJyk7XG4gIHZhciBxdWVyeSA9IG5ldyBQYXJzZS5RdWVyeShQYXJzZUZhbWlseUFwcGxpY2F0aW9uKTtcbiAgcXVlcnkuZGVzY2VuZGluZygnY3JlYXRlZEF0Jyk7XG4gIC8vIOiHquWIhuWum+OBplxuICBxdWVyeS5lcXVhbFRvKCdmcm9tVXNlcicsIHJlcXVlc3QudXNlcik7XG4gIHF1ZXJ5LmluY2x1ZGUoJ2Zyb21Vc2VyJyk7XG4gIHF1ZXJ5LmluY2x1ZGUoJ3RvVXNlcicpO1xuICBxdWVyeS5maW5kKClcbiAgLnRoZW4oKHJlc3VsdDogUGFyc2UuT2JqZWN0W10pID0+IHtcbiAgICByZXNwb25zZS5zdWNjZXNzKHJlc3VsdCk7XG4gIH0sXG4gIChlcnJvcjogUGFyc2UuRXJyb3IpID0+IHtcbiAgICByZXNwb25zZS5lcnJvcihlcnJvcik7XG4gIH0pO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=