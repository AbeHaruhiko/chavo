/// <reference path='../../../.tmp/typings/tsd.d.ts' />
Parse.Cloud.define('hello', function (request, response) {
    response.success('Hello world!');
});
Parse.Cloud.define('toggleLike', function (request, response) {
    // 人のvoiceのlikceCountをincrementするのでuseMasterKey
    Parse.Cloud.useMasterKey();
    var voice = request.params.voice;
    // ↓のトグルはローカルで実施済み
    // voice.like = !voice.like;
    var ParseVoice = Parse.Object.extend('Voice');
    var parseVoice = new ParseVoice();
    parseVoice.id = voice.objectId;
    if (voice.like) {
        request.user.addUnique('likes', voice.objectId);
        parseVoice.increment('likeCount');
    }
    else {
        request.user.remove('likes', voice.objectId);
        parseVoice.increment('likeCount', -1);
    }
    request.user.save()
        .then(function (user) {
        console.log('user: ' + user);
        console.log('likes: ' + user.get('likes'));
        return parseVoice.save();
    }, function (error) {
        console.error('Error: ' + error.code + ' ' + error.message);
        response.error('Error: ' + error.code + ' ' + error.message);
    })
        .then(function (parseVoice) {
        console.log('likeCound: ' + parseVoice.get('likeCount'));
        response.success(parseVoice.get('likeCount'));
    }, function (error) {
        console.error('Error: ' + error.code + ' ' + error.message);
        response.error('Error: ' + error.code + ' ' + error.message);
    });
});
Parse.Cloud.define('saveTag', function (request, response) {
    var tags = request.params.tags;
    tags.forEach(function (tag) {
        console.log(tag);
        var ParseTag = Parse.Object.extend('Tag');
        var query = new Parse.Query(ParseTag);
        query.equalTo('tag', tag);
        query.count().then(function (count) {
            console.log('count: ' + count);
            if (count === 0) {
                var parseTag = new ParseTag();
                parseTag.set('tag', tag);
                return parseTag.save();
            }
        })
            .then(function (parseTag) {
            if (parseTag) {
                console.log('saved tag: ' + parseTag.get('tag'));
            }
        });
    });
});
Parse.Cloud.define('addFamily', function (request, response) {
    // 人のChildを共有するようにACLを編集したりRoleを作ったりするのでマスターキー使用。
    Parse.Cloud.useMasterKey();
    // toUserIdかfromUserIdの家族を表すRoleがあるか
    var toUser = new Parse.User();
    var fromUser = new Parse.User();
    // 申請先ユーザ（承認者）
    toUser.id = request.user.id;
    // 申請元ユーザ（申請者）
    fromUser.id = request.params.familyApplication.fromUserObjectId;
    var toUserFamilyQuery = new Parse.Query('Family');
    toUserFamilyQuery.equalTo('member', request.user.id);
    var fromUserFamilyQuery = new Parse.Query('Family');
    fromUserFamilyQuery.equalTo('member', request.params.familyApplication.fromUserId);
    // orでクエリを作る。
    var familyQuery = Parse.Query.or(toUserFamilyQuery, fromUserFamilyQuery);
    var family;
    var familyRole;
    familyQuery.first().then(function (family) {
        console.log('enter 1');
        console.log(family);
        if (!family) {
            console.log('既存familyなし');
            // 既存のFamilyがないので作る。
            var ParseFamily = Parse.Object.extend('Family');
            family = new ParseFamily();
        }
        family.addUnique('member', toUser.id);
        family.addUnique('member', fromUser.id);
        return family.save();
    }).then(function (result) {
        console.log('enter 2');
        console.log(result);
        family = result;
        // .FamilyのオブジェクトIDをnameに持つRoleを探す。
        var familyRoleQuery = new Parse.Query(Parse.Role);
        console.log(result.id);
        familyRoleQuery.equalTo('name', result.id);
        return familyRoleQuery.first();
    }).then(function (result) {
        console.log('enter 3');
        console.log(result);
        if (result) {
            console.log('ロールあり: name = ' + family.id + ': ' + result);
            familyRole = result;
        }
        else {
            // 既存Roleがなければ作る。
            familyRole = new Parse.Role(family.id, new Parse.ACL());
            console.log('ロールなし: name = ' + family.id + 'を作ります。');
        }
        console.log(familyRole.getUsers());
        familyRole.getUsers().add(toUser);
        familyRole.getUsers().add(fromUser);
        return familyRole.save();
    }).then(function (result) {
        console.log('enter 4');
        console.log(result);
        // 承認者のこども情報を取得
        var ParseChild = Parse.Object.extend('Child');
        var query = new Parse.Query(ParseChild);
        return query.find();
    }).then(function (children) {
        console.log('enter 5');
        var promises = [];
        children.forEach(function (child) {
            console.log(child.get('nickName') + ':' + familyRole.getName() + 'を追加します。');
            var childACL = new Parse.ACL();
            childACL.setRoleReadAccess(familyRole, true);
            childACL.setRoleWriteAccess(familyRole, true);
            child.setACL(childACL);
            promises.push(child.save());
        });
        return Parse.Promise.when(promises);
    }).then(function () {
        console.log('enter 6');
        response.success('Success!');
    }, function (error) {
        console.error('Error: ' + error.code + ' ' + error.message);
    });
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsb3VkL21haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsdURBQXVEO0FBRXZELEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxVQUFTLE9BQW9DLEVBQUUsUUFBc0M7SUFDL0csUUFBUSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUNuQyxDQUFDLENBQUMsQ0FBQztBQUVILEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxVQUFTLE9BQW9DLEVBQUUsUUFBc0M7SUFFcEgsK0NBQStDO0lBQy9DLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDM0IsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDakMsa0JBQWtCO0lBQ2xCLDRCQUE0QjtJQUU1QixJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QyxJQUFJLFVBQVUsR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO0lBQ2xDLFVBQVUsQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQztJQUUvQixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNmLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDaEQsVUFBVSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdDLFVBQVUsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO1NBQ2xCLElBQUksQ0FBQyxVQUFDLElBQWdCO1FBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUMzQyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzNCLENBQUMsRUFDRCxVQUFDLEtBQWtCO1FBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU1RCxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDL0QsQ0FBQyxDQUFDO1NBQ0QsSUFBSSxDQUFDLFVBQUMsVUFBd0I7UUFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBQ3pELFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO0lBQ2hELENBQUMsRUFDRCxVQUFDLEtBQWtCO1FBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU1RCxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDL0QsQ0FBQyxDQUFDLENBQUM7QUFFTCxDQUFDLENBQUMsQ0FBQztBQUVILEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMs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QUF3QjtRQUMvQixPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXZCLElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNsQixRQUFRLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBbUI7WUFFbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxVQUFVLENBQUMsT0FBTyxFQUFFLEdBQUcsU0FBUyxDQUFDLENBQUM7WUFFNUUsSUFBSSxRQUFRLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDL0IsUUFBUSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM3QyxRQUFRLENBQUMsa0JBQWtCLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzlDLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFdkIsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUV0QyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDTixPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXZCLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDL0IsQ0FBQyxFQUNELFVBQUMsS0FBa0I7UUFDakIsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoiY2xvdWQvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9Jy4uLy4uLy4uLy50bXAvdHlwaW5ncy90c2QuZC50cycgLz5cblxuUGFyc2UuQ2xvdWQuZGVmaW5lKCdoZWxsbycsIGZ1bmN0aW9uKHJlcXVlc3Q6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVxdWVzdCwgcmVzcG9uc2U6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVzcG9uc2UpIHtcbiAgcmVzcG9uc2Uuc3VjY2VzcygnSGVsbG8gd29ybGQhJyk7XG59KTtcblxuUGFyc2UuQ2xvdWQuZGVmaW5lKCd0b2dnbGVMaWtlJywgZnVuY3Rpb24ocmVxdWVzdDogUGFyc2UuQ2xvdWQuRnVuY3Rpb25SZXF1ZXN0LCByZXNwb25zZTogUGFyc2UuQ2xvdWQuRnVuY3Rpb25SZXNwb25zZSkge1xuXG4gIC8vIOS6uuOBrnZvaWNl44GubGlrY2VDb3VudOOCkmluY3JlbWVudOOBmeOCi+OBruOBp3VzZU1hc3RlcktleVxuICBQYXJzZS5DbG91ZC51c2VNYXN0ZXJLZXkoKTtcbiAgdmFyIHZvaWNlID0gcmVxdWVzdC5wYXJhbXMudm9pY2U7XG4gIC8vIOKGk+OBruODiOOCsOODq+OBr+ODreODvOOCq+ODq+OBp+Wun+aWvea4iOOBv1xuICAvLyB2b2ljZS5saWtlID0gIXZvaWNlLmxpa2U7XG5cbiAgdmFyIFBhcnNlVm9pY2UgPSBQYXJzZS5PYmplY3QuZXh0ZW5kKCdWb2ljZScpO1xuICB2YXIgcGFyc2VWb2ljZSA9IG5ldyBQYXJzZVZvaWNlKCk7XG4gIHBhcnNlVm9pY2UuaWQgPSB2b2ljZS5vYmplY3RJZDtcblxuICBpZiAodm9pY2UubGlrZSkge1xuICAgIHJlcXVlc3QudXNlci5hZGRVbmlxdWUoJ2xpa2VzJywgdm9pY2Uub2JqZWN0SWQpO1xuICAgIHBhcnNlVm9pY2UuaW5jcmVtZW50KCdsaWtlQ291bnQnKTtcbiAgfSBlbHNlIHtcbiAgICByZXF1ZXN0LnVzZXIucmVtb3ZlKCdsaWtlcycsIHZvaWNlLm9iamVjdElkKTtcbiAgICBwYXJzZVZvaWNlLmluY3JlbWVudCgnbGlrZUNvdW50JywgLTEpO1xuICB9XG5cbiAgcmVxdWVzdC51c2VyLnNhdmUoKVxuICAudGhlbigodXNlcjogUGFyc2UuVXNlcikgPT4ge1xuICAgIGNvbnNvbGUubG9nKCd1c2VyOiAnICsgdXNlcik7XG4gICAgY29uc29sZS5sb2coJ2xpa2VzOiAnICsgdXNlci5nZXQoJ2xpa2VzJykpO1xuICAgIHJldHVybiBwYXJzZVZvaWNlLnNhdmUoKTtcbiAgfSxcbiAgKGVycm9yOiBQYXJzZS5FcnJvcikgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOiAnICsgZXJyb3IuY29kZSArICcgJyArIGVycm9yLm1lc3NhZ2UpO1xuXG4gICAgcmVzcG9uc2UuZXJyb3IoJ0Vycm9yOiAnICsgZXJyb3IuY29kZSArICcgJyArIGVycm9yLm1lc3NhZ2UpO1xuICB9KVxuICAudGhlbigocGFyc2VWb2ljZTogUGFyc2UuT2JqZWN0KSA9PiB7XG4gICAgY29uc29sZS5sb2coJ2xpa2VDb3VuZDogJyArIHBhcnNlVm9pY2UuZ2V0KCdsaWtlQ291bnQnKSk7XG4gICAgcmVzcG9uc2Uuc3VjY2VzcyhwYXJzZVZvaWNlLmdldCgnbGlrZUNvdW50JykpO1xuICB9LFxuICAoZXJyb3I6IFBhcnNlLkVycm9yKSA9PiB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6ICcgKyBlcnJvci5jb2RlICsgJyAnICsgZXJyb3IubWVzc2FnZSk7XG5cbiAgICByZXNwb25zZS5lcnJvcignRXJyb3I6ICcgKyBlcnJvci5jb2RlICsgJyAnICsgZXJyb3IubWVzc2FnZSk7XG4gIH0pO1xuXG59KTtcblxuUGFyc2UuQ2xvdWQuZGVmaW5lKCdzYXZlVGFnJywgZnVuY3Rpb24ocmVxdWVzdDogUGFyc2UuQ2xvdWQuRnVuY3Rpb25SZXF1ZXN0LCByZXNwb25zZTogUGFyc2UuQ2xvdWQuRnVuY3Rpb25SZXNwb25zZSkge1xuICB2YXIgdGFnczogc3RyaW5nW10gPSByZXF1ZXN0LnBhcmFtcy50YWdzO1xuXG4gIHRhZ3MuZm9yRWFjaCgodGFnOiBzdHJpbmcpID0+IHtcbiAgICBjb25zb2xlLmxvZyh0YWcpO1xuICAgIHZhciBQYXJzZVRhZyA9IFBhcnNlLk9iamVjdC5leHRlbmQoJ1RhZycpO1xuXG4gICAgdmFyIHF1ZXJ5ID0gbmV3IFBhcnNlLlF1ZXJ5KFBhcnNlVGFnKTtcbiAgICBxdWVyeS5lcXVhbFRvKCd0YWcnLCB0YWcpO1xuICAgIHF1ZXJ5LmNvdW50KCkudGhlbigoY291bnQ6IG51bWJlcikgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ2NvdW50OiAnICsgY291bnQpO1xuICAgICAgaWYgKGNvdW50ID09PSAwKSB7XG4gICAgICAgIHZhciBwYXJzZVRhZyA9IG5ldyBQYXJzZVRhZygpO1xuICAgICAgICBwYXJzZVRhZy5zZXQoJ3RhZycsIHRhZyk7XG4gICAgICAgIHJldHVybiBwYXJzZVRhZy5zYXZlKCk7XG4gICAgICB9XG4gICAgfSlcbiAgICAudGhlbigocGFyc2VUYWc6IFBhcnNlLk9iamVjdCkgPT4ge1xuICAgICAgaWYgKHBhcnNlVGFnKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdzYXZlZCB0YWc6ICcgKyBwYXJzZVRhZy5nZXQoJ3RhZycpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbn0pO1xuXG5QYXJzZS5DbG91ZC5kZWZpbmUoJ2FkZEZhbWlseScsIGZ1bmN0aW9uKHJlcXVlc3Q6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVxdWVzdCwgcmVzcG9uc2U6IFBhcnNlLkNsb3VkLkZ1bmN0aW9uUmVzcG9uc2UpIHtcblxuICAvLyDkurrjga5DaGlsZOOCkuWFseacieOBmeOCi+OCiOOBhuOBq0FDTOOCkue3qOmbhuOBl+OBn+OCilJvbGXjgpLkvZzjgaPjgZ/jgorjgZnjgovjga7jgafjg57jgrnjgr/jg7zjgq3jg7zkvb/nlKjjgIJcbiAgUGFyc2UuQ2xvdWQudXNlTWFzdGVyS2V5KCk7XG5cbiAgLy8gdG9Vc2VySWTjgYtmcm9tVXNlcklk44Gu5a625peP44KS6KGo44GZUm9sZeOBjOOBguOCi+OBi1xuICB2YXIgdG9Vc2VyID0gbmV3IFBhcnNlLlVzZXIoKTtcbiAgdmFyIGZyb21Vc2VyID0gbmV3IFBhcnNlLlVzZXIoKTtcblxuICAvLyDnlLPoq4vlhYjjg6bjg7zjgrbvvIjmib/oqo3ogIXvvIlcbiAgdG9Vc2VyLmlkID0gcmVxdWVzdC51c2VyLmlkO1xuICAvLyDnlLPoq4vlhYPjg6bjg7zjgrbvvIjnlLPoq4vogIXvvIlcbiAgZnJvbVVzZXIuaWQgPSByZXF1ZXN0LnBhcmFtcy5mYW1pbHlBcHBsaWNhdGlvbi5mcm9tVXNlck9iamVjdElkO1xuXG4gIHZhciB0b1VzZXJGYW1pbHlRdWVyeSA9IG5ldyBQYXJzZS5RdWVyeSgnRmFtaWx5Jyk7XG4gIHRvVXNlckZhbWlseVF1ZXJ5LmVxdWFsVG8oJ21lbWJlcicsIHJlcXVlc3QudXNlci5pZCk7XG5cbiAgdmFyIGZyb21Vc2VyRmFtaWx5UXVlcnkgPSBuZXcgUGFyc2UuUXVlcnkoJ0ZhbWlseScpO1xuICBmcm9tVXNlckZhbWlseVF1ZXJ5LmVxdWFsVG8oJ21lbWJlcicsIHJlcXVlc3QucGFyYW1zLmZhbWlseUFwcGxpY2F0aW9uLmZyb21Vc2VySWQpO1xuXG4gLy8gb3Ljgafjgq/jgqjjg6rjgpLkvZzjgovjgIJcbiAgdmFyIGZhbWlseVF1ZXJ5ID0gUGFyc2UuUXVlcnkub3IodG9Vc2VyRmFtaWx5UXVlcnksIGZyb21Vc2VyRmFtaWx5UXVlcnkpO1xuICB2YXIgZmFtaWx5OiBQYXJzZS5PYmplY3Q7XG4gIHZhciBmYW1pbHlSb2xlOiBQYXJzZS5Sb2xlO1xuICBmYW1pbHlRdWVyeS5maXJzdCgpLnRoZW4oKGZhbWlseTogUGFyc2UuT2JqZWN0KSA9PiB7XG4gICAgY29uc29sZS5sb2coJ2VudGVyIDEnKTtcbiAgICBjb25zb2xlLmxvZyhmYW1pbHkpO1xuXG4gICAgaWYgKCFmYW1pbHkpIHtcbiAgICAgIGNvbnNvbGUubG9nKCfml6LlrZhmYW1pbHnjgarjgZcnKTtcbiAgICAgIC8vIOaXouWtmOOBrkZhbWlseeOBjOOBquOBhOOBruOBp+S9nOOCi+OAglxuICAgICAgdmFyIFBhcnNlRmFtaWx5ID0gUGFyc2UuT2JqZWN0LmV4dGVuZCgnRmFtaWx5Jyk7XG4gICAgICBmYW1pbHkgPSBuZXcgUGFyc2VGYW1pbHkoKTtcbiAgICB9XG4gICAgZmFtaWx5LmFkZFVuaXF1ZSgnbWVtYmVyJywgdG9Vc2VyLmlkKTtcbiAgICBmYW1pbHkuYWRkVW5pcXVlKCdtZW1iZXInLCBmcm9tVXNlci5pZCk7XG4gICAgcmV0dXJuIGZhbWlseS5zYXZlKCk7XG5cbiAgfSkudGhlbigocmVzdWx0OiBQYXJzZS5PYmplY3QpID0+IHtcbiAgICBjb25zb2xlLmxvZygnZW50ZXIgMicpO1xuICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7XG5cbiAgICBmYW1pbHkgPSByZXN1bHQ7XG5cbiAgICAvLyAuRmFtaWx544Gu44Kq44OW44K444Kn44Kv44OISUTjgpJuYW1l44Gr5oyB44GkUm9sZeOCkuaOouOBmeOAglxuICAgIHZhciBmYW1pbHlSb2xlUXVlcnkgPSBuZXcgUGFyc2UuUXVlcnkoUGFyc2UuUm9sZSk7XG4gICAgY29uc29sZS5sb2cocmVzdWx0LmlkKTtcbiAgICBmYW1pbHlSb2xlUXVlcnkuZXF1YWxUbygnbmFtZScsIHJlc3VsdC5pZCk7XG4gICAgcmV0dXJuIGZhbWlseVJvbGVRdWVyeS5maXJzdCgpO1xuXG4gIH0pLnRoZW4oKHJlc3VsdDogUGFyc2UuUm9sZSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdlbnRlciAzJyk7XG4gICAgY29uc29sZS5sb2cocmVzdWx0KTtcblxuICAgIGlmIChyZXN1bHQpIHtcbiAgICAgIGNvbnNvbGUubG9nKCfjg63jg7zjg6vjgYLjgoo6IG5hbWUgPSAnICsgZmFtaWx5LmlkICsgJzogJyArIHJlc3VsdCk7XG4gICAgICBmYW1pbHlSb2xlID0gcmVzdWx0O1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyDml6LlrZhSb2xl44GM44Gq44GR44KM44Gw5L2c44KL44CCXG4gICAgICBmYW1pbHlSb2xlID0gbmV3IFBhcnNlLlJvbGUoZmFtaWx5LmlkLCBuZXcgUGFyc2UuQUNMKCkpO1xuICAgICAgY29uc29sZS5sb2coJ+ODreODvOODq+OBquOBlzogbmFtZSA9ICcgKyBmYW1pbHkuaWQgKyAn44KS5L2c44KK44G+44GZ44CCJyk7XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKGZhbWlseVJvbGUuZ2V0VXNlcnMoKSk7XG4gICAgZmFtaWx5Um9sZS5nZXRVc2VycygpLmFkZCh0b1VzZXIpO1xuICAgIGZhbWlseVJvbGUuZ2V0VXNlcnMoKS5hZGQoZnJvbVVzZXIpO1xuICAgIHJldHVybiBmYW1pbHlSb2xlLnNhdmUoKTtcblxuICB9KS50aGVuKChyZXN1bHQ6IFBhcnNlLlJvbGUpID0+IHtcbiAgICBjb25zb2xlLmxvZygnZW50ZXIgNCcpO1xuICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7XG5cbiAgICAvLyDmib/oqo3ogIXjga7jgZPjganjgoLmg4XloLHjgpLlj5blvpdcbiAgICB2YXIgUGFyc2VDaGlsZCA9IFBhcnNlLk9iamVjdC5leHRlbmQoJ0NoaWxkJyk7XG4gICAgdmFyIHF1ZXJ5ID0gbmV3IFBhcnNlLlF1ZXJ5KFBhcnNlQ2hpbGQpO1xuICAgIHJldHVybiBxdWVyeS5maW5kKCk7XG5cbiAgfSkudGhlbigoY2hpbGRyZW46IFBhcnNlLk9iamVjdFtdKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ2VudGVyIDUnKTtcblxuICAgIHZhciBwcm9taXNlcyA9IFtdO1xuICAgIGNoaWxkcmVuLmZvckVhY2goKGNoaWxkOiBQYXJzZS5PYmplY3QpID0+IHtcblxuICAgICAgY29uc29sZS5sb2coY2hpbGQuZ2V0KCduaWNrTmFtZScpICsgJzonICsgZmFtaWx5Um9sZS5nZXROYW1lKCkgKyAn44KS6L+95Yqg44GX44G+44GZ44CCJyk7XG5cbiAgICAgIHZhciBjaGlsZEFDTCA9IG5ldyBQYXJzZS5BQ0woKTtcbiAgICAgIGNoaWxkQUNMLnNldFJvbGVSZWFkQWNjZXNzKGZhbWlseVJvbGUsIHRydWUpO1xuICAgICAgY2hpbGRBQ0wuc2V0Um9sZVdyaXRlQWNjZXNzKGZhbWlseVJvbGUsIHRydWUpO1xuICAgICAgY2hpbGQuc2V0QUNMKGNoaWxkQUNMKTtcblxuICAgICAgcHJvbWlzZXMucHVzaChjaGlsZC5zYXZlKCkpO1xuICAgIH0pO1xuICAgIHJldHVybiBQYXJzZS5Qcm9taXNlLndoZW4ocHJvbWlzZXMpO1xuXG4gIH0pLnRoZW4oKCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdlbnRlciA2Jyk7XG5cbiAgICByZXNwb25zZS5zdWNjZXNzKCdTdWNjZXNzIScpO1xuICB9LFxuICAoZXJyb3I6IFBhcnNlLkVycm9yKSA9PiB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6ICcgKyBlcnJvci5jb2RlICsgJyAnICsgZXJyb3IubWVzc2FnZSk7XG4gIH0pO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=